<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vendor Dashboard - STS</title>
  <style>
    :root { --primary: #007bff; --secondary: #ff47b5; --bg: #f8f9fa; --card-bg: #ffffff; --success: #28a745; --warning: #ffc107; }
    body { font-family: sans-serif; background-color: var(--bg); padding: 15px; }
    header { text-align: center; margin-bottom: 25px; }
    .controls { max-width: 500px; margin: 0 auto 20px; }
    select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; }
    #orders { max-width: 600px; margin: 0 auto; }
    .customer-card { background: var(--card-bg); border-radius: 12px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); border-left: 5px solid var(--primary); }
    .customer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .customer-name { font-weight: bold; }
    .item-row { display: flex; justify-content: space-between; padding: 6px 0; }
    .status-btn { width: 100%; margin-top: 15px; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <header><h1>Skane Tamil Sangam</h1><h2>Vendor Dashboard</h2></header>
  <div class="controls"><select id="vendorSelect"><option value="">Choose Your Stall</option></select></div>
  <div id="orders"></div>

<script>
const API = "https://food-pre-order-backend.onrender.com";
const vendorSelect = document.getElementById("vendorSelect");
const ordersDiv = document.getElementById("orders");

fetch(`${API}/vendors-dropdown`).then(res => res.json()).then(data => {
  data.forEach(v => {
    let opt = document.createElement("option"); opt.value = v.id; opt.textContent = v.name;
    vendorSelect.appendChild(opt);
  });
});

function toggleDelivery(orderId, currentStatus) {
  const newStatus = currentStatus === 'Delivered' ? 'Pending' : 'Delivered';
  fetch(`${API}/order/${orderId}/delivery`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status: newStatus })
  }).then(() => loadVendorOrders(vendorSelect.value));
}

function loadVendorOrders(vendorId) {
  if (!vendorId) return;
  fetch(`${API}/vendor-orders/${vendorId}`).then(res => res.json()).then(data => {
    const orders = {};
    data.forEach(row => {
      if (!orders[row.order_id]) {
        orders[row.order_id] = { id: row.order_id, name: row.customer_name, phone: row.customer_phone, status: row.delivery_status || 'Pending', items: [] };
      }
      orders[row.order_id].items.push(row);
    });

    ordersDiv.innerHTML = "";
    Object.values(orders).forEach(order => {
      const isDelivered = order.status === 'Delivered';
      const card = document.createElement("div");
      card.className = "customer-card";
      card.innerHTML = `
        <div class="customer-header"><span class="customer-name">${order.name}</span><span>${order.phone}</span></div>
        <div>${order.items.map(i => `<div class="item-row"><span>${i.item_name}</span><b>Qty: ${i.quantity}</b></div>`).join('')}</div>
        <button onclick="toggleDelivery('${order.id}', '${order.status}')" class="status-btn" 
                style="background:${isDelivered ? '#28a745' : '#ffc107'}; color:${isDelivered ? 'white' : 'black'};">
          ${isDelivered ? 'âœ“ Delivered' : 'Mark as Delivered'}
        </button>`;
      ordersDiv.appendChild(card);
    });
  }).catch(() => { ordersDiv.innerHTML = "Error loading orders."; });
}

vendorSelect.addEventListener("change", () => loadVendorOrders(vendorSelect.value));
</script>
</body>
</html>